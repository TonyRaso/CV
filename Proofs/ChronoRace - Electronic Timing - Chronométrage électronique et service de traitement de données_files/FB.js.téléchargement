
function FBAskPermission(scope, action) {
    FB.login(function(response) {
        if (response.authResponse) {


            var token = response.authResponse.accessToken;
            var userId = response.authResponse.userID;

            setCookie("FBToken", token, 1);
            setCookie("FBUserId", userId, 1);

            __doPostBack(action, token);

        } else {
            console.log('User cancelled login or did not fully authorize.');
        }
    }, { scope: scope, auth_type: 'rerequest' });
}

var FBInitialized = false;
var FBToken = '';

function setCookie(cname, cvalue, exmins) {
    var d = new Date();
    d.setTime(d.getTime() + (exmins * 60 * 1000));
    var expires = "expires=" + d.toGMTString();
    document.cookie = cname + "=" + cvalue + "; " + expires;
}
function setSessionCookie(cname, cvalue) {
    document.cookie = cname + "=" + cvalue;
}
function getCookie(cname) {
    var name = cname + "=";
    var ca = document.cookie.split(';');
    for (var i = 0; i < ca.length; i++) {
        var c = ca[i].trim();
        if (c.indexOf(name) == 0) return c.substring(name.length, c.length);
    }
    return "";
}

function LoginFB(controlId, askPermission) {
    if (getCookie("FBToken") == "" || askPermission) {
        FBAskPermission('public_profile,email,user_birthday', controlId);
    }
    else {
        __doPostBack(controlId, getCookie("FBToken"));
    }
}

function EnableFaceBook(appId, enableLikeContent, lng,callback) {

    $(document).ready(function () {

        window.fbAsyncInit = function () {
            FB.init({
                appId: appId,
                oauth: true,
                status: true, // check login status
                cookie: true, // enable cookies to allow the server to access the session
                xfbml: true, // parse XFBML                    
                autoLogAppEvents: true,
                version: 'v2.9'
            });


            if (enableLikeContent) {
                FB.Event.subscribe('edge.create', function (response) {

                    //$("#log").append("like clicked?<br/>");
                    //$("#log").append($.toJSON(response) + "<br/><br/>");
                    ShowLike();
                });
                FB.Event.subscribe('edge.remove', function (response) {
                    //$("#log").append("don't like clicked?<br/>");
                    //$("#log").append($.toJSON(response) + "<br/><br/>");

                    ShowNotLike();
                });


                // listen for and handle auth.statusChange events
                FB.Event.subscribe('auth.statusChange', function (response) {
                    //$("#log").append($.toJSON(response) + "<br/><br/>");

                    if (response.authResponse) {
                        FB.api('/me', function (me) {
                            if (me.name) {
                                $("#log").append(me.name + " logged in fb<br/>");
                            }
                        });
                        ShowFbLogged();
                    } else {
                        // user has not auth'd your app, or is not logged into Facebook                        
                        $("#log").append("not logged in fb<br/>");
                        ShowNotLike();
                        ShowFbNotLogged();
                    }
                });


                FB.getLoginStatus(function (response) {
                    $("#log").append("GetLoginStatus<br/>");
                    if (response.error) {
                        $("#log").append(response.error.message);
                        ShowNotLike();
                        ShowFbNotLogged();
                        return;
                    }
                    if (response.status === 'connected') {
                        // the user is logged in and has authenticated your
                        // app, and response.authResponse supplies
                        // the user's ID, a valid access token, a signed
                        // request, and the time the access token 
                        // and signed request each expire

                        var uid = response.authResponse.userID;
                        var accessToken = response.authResponse.accessToken;

                        ShowFbLogged();

                        $("#log").append("uid: " + uid);
                        $("#log").append("accessToken: " + accessToken);


                        var fql_query = "SELECT uid FROM page_fan WHERE page_id = 129590133777462 and uid=" + uid;

                        FB.Data.query(fql_query).wait(function (rows) {
                            if (rows.length == 1 && rows[0].uid == uid) {
                                //      $("#log").append("like<br/>");
                                ShowLike();
                            } else {
                                //       $("#log").append("don't like<br/>");
                                ShowNotLike();

                            }
                        });

                    } else if (response.status === 'not_authorized') {
                        //  $("#log").append("not authorized<br/>");
                        ShowNotLike();
                        ShowFbNotLogged();
                    } else {
                        // the user isn't logged in to Facebook.
                        // $("#log").append("you are not logged<br/>");
                        ShowNotLike();
                        ShowFbNotLogged();
                    }
                }, true);
            }

            if (callback) {
                callback();
            }
        };

        var fbLng = "en_US";
        switch (lng.toLowerCase()) {
            case "fr":
                fbLng = "fr_FR";
                break;

            case "nl":
                fb = "nl_NL";
                break;
        }

        // Load the SDK Asynchronously

        (function (d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) return;
            js = d.createElement(s);
            js.id = id;
            js.src = "//connect.facebook.net/" + fbLng + "/all.js#xfbml=1&appId=" + appId;
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));

    });
}

function ShowLike() {
    $('.FBNotLike').hide();
    $('.FBLike').show();
}
function ShowNotLike() {
    $('.FBLike').hide();
    $('.FBNotLike').show();
}
function ShowFbLogged()
{
    $('.FBNotLogged').hide();
    $('.FBLogged').show();
}
function ShowFbNotLogged() {
    $('.FBLogged').hide();
    $('.FBNotLogged').show();
}
